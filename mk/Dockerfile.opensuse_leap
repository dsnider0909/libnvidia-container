ARG IMAGESPEC=opensuse/leap:15.0
FROM ${IMAGESPEC}
ARG IMAGESPEC=opensuse/leap:15.0

SHELL ["/bin/bash", "-c"]

RUN zypper install -y curl && \
    rm -rf /var/cache/zypp/*

RUN distrib=opensuse${IMAGESPEC##*:} && \
    arch=$(uname -m); distrib=${distrib//.0}; distrib=${distrib//.} && \
    zypper -n ar http://developer.download.nvidia.com/compute/cuda/repos/${distrib}/$arch cuda && \
    zypper --gpg-auto-import-keys install -y \
        bzip2 \
        createrepo \
        cuda-misc-headers-10-0-10.0.130-1 \
        cuda-nvml-dev-10-0-10.0.130-1 \
        libelf-devel \
        gcc \
        git \
        pkg-config \
        libcap-devel \
        libseccomp-devel \
        m4 \
        make \
        bmake \
        groff \
        lsb-release \
        rpm-build \
        rpmlint \
        which && \
    rm -rf /var/cache/zypp/*

ARG WITH_LIBELF=no
ARG WITH_TIRPC=no
ARG WITH_SECCOMP=yes
ENV WITH_LIBELF=${WITH_LIBELF}
ENV WITH_TIRPC=${WITH_TIRPC}
ENV WITH_SECCOMP=${WITH_SECCOMP}

ARG USERSPEC=0:0

WORKDIR /tmp/libnvidia-container
COPY . .
RUN chown -R $USERSPEC $PWD
USER $USERSPEC

# META_NOECHO=echo is required to work around a bug in Leap 15's version of bmake,
# see also https://github.com/ptt/pttbbs/issues/30
RUN export META_NOECHO=echo && \
    make distclean && make CUDA_DIR=$(ls -d /usr/local/cuda-*/) -j"$(nproc)"

ENV DIST_DIR /mnt
VOLUME $DIST_DIR
CMD make dist && make rpm
